/*
 Data plugin for Highcharts

 (c) 2012-2014 Torstein Honsi

 License: www.highcharts.com/license
*/
(function(f){var l=f.each,r=function(b,a){this.init(b,a)};f.extend(r.prototype,{init:function(b,a){this.options=b;this.chartOptions=a;this.columns=b.columns||this.rowsToColumns(b.rows)||[];this.columns.length?this.dataFound():(this.parseCSV(),this.parseTable(),this.parseGoogleSpreadsheet())},getColumnDistribution:function(){var b=this.chartOptions,a=b&&b.chart&&b.chart.type,d=[];l(b&&b.series||[],function(b){d.push((f.seriesTypes[b.type||a||"line"].prototype.pointArrayMap||[0]).length)});this.valueCount=
{global:(f.seriesTypes[a||"line"].prototype.pointArrayMap||[0]).length,individual:d}},dataFound:function(){this.parseTypes();this.findHeaderRow();this.parsed();this.complete()},parseCSV:function(){var b=this,a=this.options,d=a.csv,c=this.columns,e=a.startRow||0,n=a.endRow||Number.MAX_VALUE,g=a.startColumn||0,q=a.endColumn||Number.MAX_VALUE,m=0;if(d){var k=d.replace(/\r\n/g,"\n").replace(/\r/g,"\n").split(a.lineDelimiter||"\n");var f=a.itemDelimiter||(-1!==d.indexOf("\t")?"\t":",");l(k,function(a,
d){var k=b.trim(a),h=0===k.indexOf("#");d>=e&&d<=n&&!h&&""!==k&&(a=a.split(f),l(a,function(b,a){a>=g&&a<=q&&(c[a-g]||(c[a-g]=[]),c[a-g][m]=b)}),m+=1)});this.dataFound()}},parseTable:function(){var b=this.options,a=b.table,d=this.columns,c=b.startRow||0,e=b.endRow||Number.MAX_VALUE,n=b.startColumn||0,g=b.endColumn||Number.MAX_VALUE,f;a&&("string"===typeof a&&(a=document.getElementById(a)),l(a.getElementsByTagName("tr"),function(a,b){f=0;b>=c&&b<=e&&l(a.childNodes,function(a){("TD"===a.tagName||"TH"===
a.tagName)&&f>=n&&f<=g&&(d[f]||(d[f]=[]),d[f][b-c]=a.innerHTML,f+=1)})}),this.dataFound())},parseGoogleSpreadsheet:function(){var b=this,a=this.options,d=a.googleSpreadsheetKey,c=this.columns,e=a.startRow||0,f=a.endRow||Number.MAX_VALUE,g=a.startColumn||0,l=a.endColumn||Number.MAX_VALUE,m,k;d&&jQuery.getJSON("https://spreadsheets.google.com/feeds/cells/"+d+"/"+(a.googleSpreadsheetWorksheet||"od6")+"/public/values?alt=json-in-script&callback=?",function(a){a=a.feed.entry;var d=a.length,n=0,q=0,h;for(h=
0;h<d;h++){var p=a[h];n=Math.max(n,p.gs$cell.col);q=Math.max(q,p.gs$cell.row)}for(h=0;h<n;h++)h>=g&&h<=l&&(c[h-g]=[],c[h-g].length=Math.min(q,f-e));for(h=0;h<d;h++)p=a[h],m=p.gs$cell.row-1,k=p.gs$cell.col-1,k>=g&&k<=l&&m>=e&&m<=f&&(c[k-g][m-e]=p.content.$t);b.dataFound()})},findHeaderRow:function(){l(this.columns,function(b){});this.headerRow=0},trim:function(b){return"string"===typeof b?b.replace(/^\s+|\s+$/g,""):b},parseTypes:function(){for(var b=this.columns,a=b.length,d,c,e,f;a--;)for(d=b[a].length;d--;)c=
b[a][d],e=parseFloat(c),f=this.trim(c),f==e?(b[a][d]=e,31536E6<e?b[a].isDatetime=!0:b[a].isNumeric=!0):(c=this.parseDate(c),0!==a||"number"!==typeof c||isNaN(c)?b[a][d]=""===f?null:f:(b[a][d]=c,b[a].isDatetime=!0))},dateFormats:{"YYYY-mm-dd":{regex:"^([0-9]{4})-([0-9]{2})-([0-9]{2})$",parser:function(b){return Date.UTC(+b[1],b[2]-1,+b[3])}}},parseDate:function(b){var a=this.options.parseDate,d,c,e;a&&(d=a(b));if("string"===typeof b)for(c in this.dateFormats)a=this.dateFormats[c],(e=b.match(a.regex))&&
(d=a.parser(e));return d},rowsToColumns:function(b){var a,d;if(b){var c=[];var e=b.length;for(a=0;a<e;a++){var f=b[a].length;for(d=0;d<f;d++)c[d]||(c[d]=[]),c[d][a]=b[a][d]}}return c},parsed:function(){this.options.parsed&&this.options.parsed.call(this,this.columns)},complete:function(){var b=this.columns,a,d=this.options,c,e,n;if(d.complete){this.getColumnDistribution();if(1<b.length){var g=b.shift();0===this.headerRow&&g.shift();g.isDatetime?a="datetime":g.isNumeric||(a="category")}for(c=0;c<b.length;c++)0===
this.headerRow&&(b[c].name=b[c].shift());var l=[];for(n=c=0;c<b.length;n++){var m=f.pick(this.valueCount.individual[n],this.valueCount.global);var k=[];for(e=0;e<b[c].length;e++)k[e]=[g[e],void 0!==b[c][e]?b[c][e]:null],1<m&&k[e].push(void 0!==b[c+1][e]?b[c+1][e]:null),2<m&&k[e].push(void 0!==b[c+2][e]?b[c+2][e]:null),3<m&&k[e].push(void 0!==b[c+3][e]?b[c+3][e]:null),4<m&&k[e].push(void 0!==b[c+4][e]?b[c+4][e]:null);l[n]={name:b[c].name,data:k};c+=m}d.complete({xAxis:{type:a},series:l})}}});f.Data=
r;f.data=function(b,a){return new r(b,a)};f.wrap(f.Chart.prototype,"init",function(b,a,d){var c=this;a&&a.data?f.data(f.extend(a.data,{complete:function(e){a.series&&l(a.series,function(b,c){a.series[c]=f.merge(b,e.series[c])});a=f.merge(e,a);b.call(c,a,d)}}),a):b.call(c,a,d)})})(Highcharts);
